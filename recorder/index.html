<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>%((phone-in-hand):choir-practice)&</title>
    <!-- vendor libraries -->
    <script type="text/javascript" src="./vendor/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="./vendor/js/Tone.min.js"></script>
    <!-- <script type="text/javascript" src="./vendor/js/socket.io.js"></script> -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/binaryjs/0.2.1/binary.min.js"></script>
    <link rel="stylesheet" href="./vendor/css/tachyons.min.css"/>
    <link rel="stylesheet" href="./vendor/css/colors.css">
    <!-- dev libraries -->
    <script type="text/javascript" src="./js/webscope.js"></script>
    <script type="text/javascript" src="./js/ui.js"></script>
    <script type="text/javascript" src="./js/mavg.js"></script>
    <script type="text/javascript" src="./js/aging.js"></script>
    <link rel="stylesheet" href="./css/loading-animation.css"/>
    <!-- dev code -->
    <!-- <script type="text/javascript" src="./js/motion.js"></script> -->
    <!-- <script type="text/javascript" src="./js/instruments.js"></script> -->
    <script type="text/javascript" src="./js/script.js"></script>
    <style>
     /* default font */
     @import url(//fonts.googleapis.com/earlyaccess/notosanskr.css);
     .noto { font-family: "Noto Sans", "Noto Sans CJK JP", sans-serif; }

     /* flex layout fine control */

     /* mobile-sized < 600px */

     .flex-half {
       -webkit-box-flex: 1;
       -ms-flex: 1 1 auto;
       flex: 1 1 0;
       min-width: 0; /* 1 */
       min-height: 0; /* 1 */
     }

     @media all and (min-width: 600px) { /* tablet-sized > 600px */
       .aside { flex: 1 auto; }
     }

     @media all and (min-width: 800px) { /* full-scaled > 800px */
       .main { flex: 3 0px; }
     }
    </style>
    <style>
     /* backgrounds */
     .bg-mocha-latte { background-color: #C9AF94; }
     .bg-latte { background-color: #9F703A; }
     .bg-sign-orange { background-color: #DD7500; }
     .bg-pineapple { background-color: #FCDC3B; }
     .bg-pear { background-color: #D1E231; }
     .bg-goldgreen { background-color: #AADD00; }

     /* foregrounds */
     .pomegranate { color: #F64D54; }

     /* reference > http://www.december.com/html/spec/colorcodes.html */
    </style>
  </head>
  <body class="bg-goldgreen min-h-100 h-auto noto">

    <!-- top sticky overlay-ed flasher -->
    <div class="flasher fixed top-0 left-0 vh-100 w-100 bg-white z-max" style="display:none"></div>

    <!-- full page layout START -->
    <div class="lout-fullpage vh-100 w-100 absolute top-0 left-0">
      <div class="cf w-100 top-0">

        <!-- top sticky system status header -->
        <div class="absolute top-0 right-0 pt2 pr2">
          <input type="checkbox" class="netstat input-reset dib br-100 w2 h2 ba bw2 b--near-black" value="0"/>
        </div>

        <div class="page-recording ui-page fl w-100">
          <div class="fl w-100 center ph4-ns ph3">

            <div class="page-recording-header fl w-100">
              <div class="tc pv4-ns pv2 lh-copy f3 fw6">
                <span class="pomegranate bg-white ph4-ns ph2 f2-ns f4 b">* 녹 음 실 * Voice Recorder *</span>
              </div>
            </div><!-- end of .page-recording-header -->
            <div class="page-recording-body fl w-100 tc pv4-ns pv2">
              <div class="cf w-90-ns w-100 bg-teal pv3-ns pv2" style="border-radius: 3em">
                <div class="fl w-third-ns w-50">
                  <div class="pv3-ns pv2 ph2-ns ph0 mh4-ns mh0 br4 lh-copy bg-yellow">
                    노이즈 제거
                    <div class="fl w-100 v-mid tc"><canvas class="dib scope1"></canvas></div>
                    <div class="fl w-100 v-mid tc"><canvas class="scope2"></canvas></div>
                    <div class="fl w-100 v-mid tc"><canvas class="scope3"></canvas></div>
                  </div>
                </div>
                <div class="fl w-third-ns w-50">
                  <div class="pv3-ns pv2 ph2-ns ph0 mh4-ns mh0 br4 lh-copy bg-blue">
                    목소리 녹음 상태
                    <div id="Content"></div>
                    <button class="start-rec">Start Recording</button>
                    <button class="stop-rec">Recording</button>
                    <div class="cf fl w-100">
                      <div class="tc">
                        <div class="dib w-100 pb3">
                          <div class="tone-rec dib br-100 w4 h4 ba bw2 white b--yellow">
                            <div class="dt w-100 h4">
                              <div class="dtc v-mid tc">
                                <div class="dib">tone.js REC-start.</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="fl w-third-ns w-100">
                  <div class="pv3-ns pv2 ph2-ns ph0 mh4-ns mh0 br4 lh-copy bg-green">
                    설명 및 가이드
                    <div class="fl w-50">
                      <div class="tc pv3 lh-copy f3 fw6">
                        <span class="f3 fw7 b">!@#$%^&*</span><br>
                      </div>
                    </div>
                    <div class="fl w-50">
                      <div class="tc pv3 lh-copy f3 fw6">
                        <span class="prog-no f3 fw7 b">0</span><br>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div><!-- end of .page-recording-body -->

          </div>
        </div><!-- end of .page-recording -->

        <script>/* start of 'record-and-stream' */
         $(document).ready(function () {

           var client = new BinaryClient('wss://choir.run:9001');

           client.on('open', function() {
             window.Stream = client.createStream();

             if (!navigator.getUserMedia)
               navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                                        navigator.mozGetUserMedia || navigator.msGetUserMedia;

             if (navigator.getUserMedia) {
               navigator.getUserMedia({audio:true}, success, function(e) {
                 alert('Error capturing audio.');
               });
             } else alert('getUserMedia not supported in this browser.');

             var recording = false;

             $(".start-rec").click(function() {
               recording = true;
             });

             $(".stop-rec").click(function() {
               recording = false;
               window.Stream.end();
             });

             function success(e) {
               audioContext = window.AudioContext || window.webkitAudioContext;
               context = new audioContext();

               // the sample rate is in context.sampleRate
               audioInput = context.createMediaStreamSource(e);

               var bufferSize = 2048;
               recorder = context.createScriptProcessor(bufferSize, 1, 1);

               recorder.onaudioprocess = function(e){
                 if(!recording) return;
                 console.log ('recording');
                 var left = e.inputBuffer.getChannelData(0);
                 window.Stream.write(convertoFloat32ToInt16(left));
               }

               audioInput.connect(recorder)
               recorder.connect(context.destination);
             }

             function convertoFloat32ToInt16(buffer) {
               var l = buffer.length;
               var buf = new Int16Array(l)

               while (l--) {
                 buf[l] = buffer[l]*0xFFFF;    //convert to 16 bit
               }
               return buf.buffer
             }
           });
         });
        </script><!-- end of .record-and-stream -->
        <script>
         $(document).ready(function () {
           //you probably DONT want to connect the microphone
           //directly to the master output because of feedback.
           var mic = new Tone.UserMedia();
           g_a = mic;

           var analyser = new Tone.Analyser({
             "type" : "waveform",
             "size" : 256
           });

           var comp = new Tone.Compressor(-30, 3);

           mic.connect(analyser);

           var meter = new Tone.Meter();
           //connect mic to the meter
           mic.connect(meter);
           //the current level of the mic input
           /* console.log(meter.value);*/

           var scope1 = new Webscope($(".scope1").get(0), -2, 2, 300);
           var scope2 = new Webscope($(".scope2").get(0), -2, 2, 300);
           /* var scope3 = new Webscope($(".scope3").get(0), -12, 12, 300);*/
           var scope3 = new Webscope($(".scope3").get(0), -2, 2, 300);

           var aging1 = new Aging(10, 1, 10, 0);

           // GUI //

           //indicate if the microphone is supported or not
           if (!Tone.UserMedia.supported){
             $("<div>", {
               "id" : "NotSupported",
               "text" : "getUserMedia is not supported by your browser."
             }).appendTo("#Content");
           } else {

             var canvas = $("<canvas>").appendTo("#Content");

             var context = canvas.get(0).getContext("2d");

             context.canvas.width = canvas.width();
             context.canvas.height = canvas.height();

             function drawLoop(){
               var canvasWidth = context.canvas.width;
               var canvasHeight = context.canvas.height;
               requestAnimationFrame(drawLoop);
               //draw the waveform
               context.clearRect(0, 0, canvasWidth, canvasHeight);
               var values = analyser.analyse();
               context.beginPath();
               context.lineJoin = "round";
               context.lineWidth = 6;
               context.strokeStyle = "white";
               context.moveTo(0, (values[0] / 255) * canvasHeight);
               for (var i = 1, len = values.length; i < len; i++){
                 var val = values[i] / 255;
                 var x = canvasWidth * (i / (len - 1));
                 var y = val * canvasHeight;
                 context.lineTo(x, y);
               }
               context.stroke();
               //
               scope1.update(meter.value);
               scope2.update(meter.value > 0.6);
               scope3.update(aging1.update(meter.value > 0.6).get() > 5);
             }
             drawLoop();
           }

           $(".tone-rec").click(function () {
             mic.open();
           });
         })
        </script>
      </div>
    </div><!-- end of .lout-fullpage -->

  </body>
</html>
<!-- <div class="tc">
     <div class="dib w-50 pb3">
     <div class="btn-touch dib br-100 w3 h3 ba bw2 b--yellow"></div>
     </div>
     </div> -->
