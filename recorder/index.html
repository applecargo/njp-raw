<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>%((space)package)&</title>
    <!-- vendor libraries -->
    <script type="text/javascript" src="./vendor/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="./vendor/js/Tone.min.js"></script>
    <script type="text/javascript" src="./vendor/js/socket.io.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/binaryjs/0.2.1/binary.min.js"></script>
    <link rel="stylesheet" href="./vendor/css/tachyons.min.css"/>
    <link rel="stylesheet" href="./vendor/css/colors.css">
    <!-- dev libraries -->
    <script type="text/javascript" src="./js/webscope.js"></script>
    <script type="text/javascript" src="./js/ui.js"></script>
    <script type="text/javascript" src="./js/mavg.js"></script>
    <link rel="stylesheet" href="./css/loading-animation.css"/>
    <!-- dev code -->
    <script type="text/javascript" src="./js/motion.js"></script>
    <script type="text/javascript" src="./js/instruments.js"></script>
    <script type="text/javascript" src="./js/script.js"></script>
  </head>
  <body class="bg-near-black min-h-100 h-auto">

    <!-- top sticky overlay-ed flasher -->
    <div class="flasher fixed top-0 left-0 vh-100 w-100 bg-white z-max" style="display:none"></div>

    <!-- full page layout START -->
    <div class="vh-100 w-100 absolute top-0 left-0 bg-near-black">
      <div class="cf w-100 top-0">

	<!-- full page layout block START -->
	<!-- top sticky system status header -->
	<div class="absolute top-0 right-0 pt2 pr2">
	  <input type="checkbox" class="netstat input-reset dib br-100 w2 h2 ba bw2 b--near-black" value="0"/>
	</div>

	<!-- page - sound & (checklist) -->
	<div class="ui-page fl w-100" id="page-checklist">
	  <div class="fl w-100 center ph4">

	    <!-- {layout block START} -->
	    <div class="fl w-100">
	      <div class="tc pv3 lh-copy f3 fw6">
		<span class="white f4 fw7 b">MINIMALISTIC</span>
	      </div>
	    </div>
	    <div class="fl w-100">
	      <div class="tc pv3 lh-copy f3 fw6">
		<span class="yellow f3 fw7 b">TURN ON, the SPEAKER!!</span><br>
		<span class="lime f3 fw7 b">ENABLE WIFI/LTE!!</span><br>
		<span class="blue f3 fw7 b">CHECK SOUND!! (below)</span>
	      </div>
	    </div>
	    <div class="fl w-100">
	      <div class="tc">
		<div class="dib w-50 pb3">
		  <div class="touch dib br-100 w3 h3 ba bw2 b--yellow"></div>
		</div>
	      </div>
	    </div>
	    <div class="fl w-50">
	      <div class="tc pv3 lh-copy f3 fw6">
		<span class="light-blue f3 fw7 b">!@#$%^&*</span><br>
	      </div>
	    </div>
	    <div class="fl w-50">
	      <div class="tc pv3 lh-copy f3 fw6">
		<span class="prog-no lime f3 fw7 b">0</span><br>
	      </div>
	    </div>
	    <!-- {layout block END} -->
	    
	  </div>
	</div>
	<!-- full page layout block END -->
	
        <button class="start-rec">Start Recording</button>
        <button class="stop-rec">Stop Recording</button>
        <script>
         $(document).ready(function () {
           
           var client = new BinaryClient('ws://localhost:9001');

           client.on('open', function() {
             window.Stream = client.createStream();

             if (!navigator.getUserMedia)
               navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                                        navigator.mozGetUserMedia || navigator.msGetUserMedia;

             if (navigator.getUserMedia) {
               navigator.getUserMedia({audio:true}, success, function(e) {
                 alert('Error capturing audio.');
               });
             } else alert('getUserMedia not supported in this browser.');

             var recording = false;

             $(".start-rec").click(function() {
               recording = true;
             });

             $(".stop-rec").click(function() {
               recording = false;
               window.Stream.end();
             });

             function success(e) {
               audioContext = window.AudioContext || window.webkitAudioContext;
               context = new audioContext();

               // the sample rate is in context.sampleRate
               audioInput = context.createMediaStreamSource(e);

               var bufferSize = 2048;
               recorder = context.createScriptProcessor(bufferSize, 1, 1);

               recorder.onaudioprocess = function(e){
                 if(!recording) return;
                 console.log ('recording');
                 var left = e.inputBuffer.getChannelData(0);
                 window.Stream.write(convertoFloat32ToInt16(left));
               }

               audioInput.connect(recorder)
               recorder.connect(context.destination); 
             }

             function convertoFloat32ToInt16(buffer) {
               var l = buffer.length;
               var buf = new Int16Array(l)

               while (l--) {
                 buf[l] = buffer[l]*0xFFFF;    //convert to 16 bit
               }
               return buf.buffer
             }
           });
         });
        </script>
	<div class="fl w-100">
	  <div class="tc">
	    <div class="dib w-100 pb3">
	      <div class="tone-rec dib br-100 w4 h4 ba bw2 white b--yellow">
                <div class="dt w-100 h4">
                  <div class="dtc v-mid tc"><div class="dib">tone.js REC-start.</div></div>
                </div>
              </div>
	    </div>
	  </div>
	</div>
        <div id="Content"></div>
        <script>
         var g_a;

         $(document).ready(function () {
	   //you probably DONT want to connect the microphone
	   //directly to the master output because of feedback.
	   var mic = new Tone.UserMedia();
           g_a = mic;

	   var analyser = new Tone.Analyser({
	     "type" : "waveform",
	     "size" : 256
	   });

	   mic.connect(analyser);

	   // GUI //

	   //indicate if the microphone is supported or not
	   if (!Tone.UserMedia.supported){
	     $("<div>", {
	       "id" : "NotSupported",
	       "text" : "getUserMedia is not supported by your browser."
	     }).appendTo("#Content");
	   } else {

	     var canvas = $("<canvas>").appendTo("#Content");

	     var context = canvas.get(0).getContext("2d");

	     context.canvas.width = canvas.width();
	     context.canvas.height = canvas.height();

	     function drawLoop(){
	       var canvasWidth = context.canvas.width;
	       var canvasHeight = context.canvas.height;
	       requestAnimationFrame(drawLoop);
	       //draw the waveform
	       context.clearRect(0, 0, canvasWidth, canvasHeight);
	       var values = analyser.analyse();
	       context.beginPath();
	       context.lineJoin = "round";
	       context.lineWidth = 6;
	       context.strokeStyle = "white";
	       context.moveTo(0, (values[0] / 255) * canvasHeight);
	       for (var i = 1, len = values.length; i < len; i++){
	         var val = values[i] / 255;
	         var x = canvasWidth * (i / (len - 1));
	         var y = val * canvasHeight;
	         context.lineTo(x, y);
	       }
	       context.stroke();
	     }
	     drawLoop();
           }

           $(".tone-rec").click(function () {
             mic.open();
           });
         })
        </script>
      </div>
    </div>
    <!-- full page layout END -->
    
  </body>
</html>
